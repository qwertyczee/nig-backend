<!DOCTYPE html>
<html lang="cs"> <head> <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Přidat nový produkt</title> <style> body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background-color: #f0f2f5; display: flex; min-height: 100vh; color: #333; } .sidebar { width: 250px; background-color: #283747; color: white; padding: 20px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); display: flex; flex-direction: column; } .sidebar h2 { text-align: center; margin-bottom: 30px; color: #ecf0f1; } .sidebar ul { list-style: none; padding: 0; flex-grow: 1; } .sidebar ul li { margin-bottom: 15px; } .sidebar ul li a { color: #bdc3c7; text-decoration: none; padding: 10px 15px; display: block; border-radius: 5px; transition: background-color 0.3s ease; } .sidebar ul li a:hover, .sidebar ul li a.active { background-color: #34495e; color: white; } .main-content { flex-grow: 1; padding: 30px; background-color: #ffffff; border-radius: 8px; margin: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); } .main-content h1 { color: #2c3e50; margin-bottom: 25px; border-bottom: 1px solid #eee; padding-bottom: 15px; } .form-container { background-color: #fdfdfd; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); } .form-group { margin-bottom: 20px; /* Zvětšený margin */ } .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; } .form-group input[type="text"], .form-group input[type="number"], .form-group textarea, .form-group select { /* Přidán select */ width: 100%; /* Změněno pro plnou šířku */ padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 1em; } .form-group textarea { resize: vertical; min-height: 100px; /* Zvětšená výška */ } .form-group input[type="file"] { /* Styling pro file input */ padding: 8px; border: 1px solid #ccc; border-radius: 5px; } .form-group input[type="checkbox"] { margin-right: 10px; vertical-align: middle; } .form-group label[for*="is_18_plus"], .form-group label[for*="in_stock"] { /* Inline pro checkbox labels */ display: inline-block; font-weight: normal; } .image-preview-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; } .image-preview-container img { max-width: 100px; max-height: 100px; border-radius: 4px; border: 1px solid #ddd; object-fit: cover; } .section-title { font-size: 1.4em; color: #2c3e50; margin-top: 30px; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee; } .form-actions { margin-top: 30px; display: flex; gap: 10px; justify-content: flex-end; /* Zarovnání tlačítek vpravo */ } .form-actions button, .form-actions .cancel-btn { /* Sjednocení stylu pro cancel button */ padding: 12px 25px; /* Větší padding */ border: none; border-radius: 5px; cursor: pointer; font-size: 1em; font-weight: bold; transition: background-color 0.3s ease; } .form-actions .save-btn { background-color: #007bff; color: white; } .form-actions .save-btn:hover { background-color: #0056b3; } .form-actions .cancel-btn { background-color: #6c757d; color: white; text-decoration: none; /* Pro <a> tag */ display: inline-block; /* Pro <a> tag */ text-align: center; } .form-actions .cancel-btn:hover { background-color: #5a6268; } .message { margin-bottom: 20px; padding: 15px; border-radius: 5px; font-size: 0.95em; } .error-message { color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; } .success-message { color: #155724; background-color: #d4edda; border: 1px solid #c3e6cb; } .logout-btn { background-color: #e74c3c; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; text-align: center; text-decoration: none; margin-top: auto; transition: background-color 0.3s ease; } .logout-btn:hover { background-color: #c0392b; } </style>
</head>
<body>
    <div class="sidebar">
        <h2>Admin Panel</h2>
        <ul>
            <li><a href="/api/admin/dashboard">Dashboard</a></li>
            <li><a href="/api/admin/products" class="active">Produkty</a></li>
            <li><a href="/api/admin/orders">Objednávky</a></li>
        </ul>
        <a href="/api/admin/logout" class="logout-btn">Odhlásit se</a>
    </div>
    <div class="main-content">
        <h1>Přidat nový produkt</h1>
        <div id="message-area"></div>
        <div class="form-container">
            <form id="new-product-form" enctype="multipart/form-data">
                
                <div class="form-group">
                    <label for="name">Title produktu:</label>
                    <input type="text" id="name" name="name" required>
                </div>

                <div class="form-group">
                    <label for="description">Popis produktu:</label>
                    <textarea id="description" name="description"></textarea>
                </div>

                <div class="form-group">
                    <label for="price">Price (CZK):</label>
                    <input type="number" id="price" name="price" step="0.01" min="0" required>
                </div>
                
                <div class="form-group">
                    <label for="category_select">Kategorie:</label>
                    <select id="category_select" name="category" required>
                        <option value="">Načítání kategorií...</option>
                        <!-- Kategorie budou načteny pomocí JavaScriptu -->
                    </select>
                </div>

                <div class="form-group">
                    <label for="main_image_upload">Main image (hlavní obrázek):</label>
                    <input type="file" id="main_image_upload" accept="image/*" name="main_image">
                    <div id="main_image_preview" class="image-preview-container"></div>
                </div>
                
                <div class="form-group">
                    <label for="sub_image_upload">Sub images (další obrázky produktu):</label>
                    <input type="file" id="sub_image_upload" accept="image/*" multiple name="sub_images">
                    <div id="sub_image_preview" class="image-preview-container"></div>
                </div>
                
                <h2 class="section-title">Co uživatel obdrží</h2>
                <div class="form-group">
                    <label for="received_text">Textový popis obsahu balení / služby:</label>
                    <textarea id="received_text" name="received_text"></textarea>
                </div>
                <div class="form-group">
                    <label for="received_images_upload">Fotky obsahu balení / služby:</label>
                    <input type="file" id="received_images_upload" accept="image/*" multiple name="received_images">
                    <div id="received_images_preview" class="image-preview-container"></div>
                </div>

                <h2 class="section-title">Další nastavení</h2>
                <div class="form-group">
                    <label for="likes_input">"Líbí se" (položky oddělené čárkou, např. Rychlé dodání, Kvalitní materiál):</label>
                    <input type="text" id="likes_input" name="likes_input_text"> <!-- Změna name atributu, abychom to zpracovali v JS -->
                    <input type="hidden" id="likes" name="likes" value="[]">
                </div>
                <div class="form-group">
                    <input type="checkbox" id="is_18_plus" name="is_18_plus" value="true">
                    <label for="is_18_plus">Produkt je 18+</label>
                </div>
                <div class="form-group">
                    <label for="mail_content">Obsah emailu po zakoupení (speciální instrukce, poděkování):</label>
                    <textarea id="mail_content" name="mail_content"></textarea>
                </div>
                
                <div class="form-group">
                    <input type="checkbox" id="in_stock" name="in_stock" value="true" checked>
                    <label for="in_stock">Produkt je skladem</label>
                </div>

                <!-- Skrytá pole pro URLs obrázků - mohou být užitečná pro editaci, pro nový produkt se neodesílají, ale nechávám pro konzistenci -->
                <input type="hidden" id="main_image_url" name="main_image_url">
                <input type="hidden" id="sub_image_urls" name="sub_image_urls" value="[]">
                <input type="hidden" id="received_images_urls" name="received_images_urls" value="[]">


                <div class="form-actions">
                    <button type="submit" class="save-btn">Přidat produkt</button>
                    <a href="/api/admin/products" class="cancel-btn">Zrušit</a>
                </div>
            </form>
        </div>
    </div>

    <script>
        const form = document.getElementById('new-product-form');
        const msgArea = document.getElementById('message-area');
        
        const mainImageUploadInput = document.getElementById('main_image_upload');
        const subImageUploadInput = document.getElementById('sub_image_upload');
        const receivedImagesUploadInput = document.getElementById('received_images_upload');
        
        const mainImagePreviewDiv = document.getElementById('main_image_preview');
        const subImagePreviewDiv = document.getElementById('sub_image_preview');
        const receivedImagesPreviewDiv = document.getElementById('received_images_preview');
        
        const categorySelect = document.getElementById('category_select');
        const likesInputText = document.getElementById('likes_input'); // Textové pole pro uživatele
        const likesHidden = document.getElementById('likes'); // Skryté pole pro JSON pole

        // Funkce pro zobrazení náhledu obrázku
        function displayImagePreview(file, previewContainer) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.createElement('img');
                img.src = e.target.result;
                // Styl pro obrázky je v CSS (.image-preview-container img)
                previewContainer.appendChild(img);
            };
            reader.readAsDataURL(file);
        }

        // Funkce pro zobrazení náhledů pro skupinu souborů
        function setupImageUploadPreview(inputElement, previewDivElement) {
            inputElement.addEventListener('change', e => {
                if (inputElement.multiple) { // Pro multiple files, nepřepisujeme, ale přidáváme
                     // previewDivElement.innerHTML = ''; // Nemažeme, pokud chceme přidávat další soubory postupně. Pro nový produkt je lepší mazat.
                } else {
                    previewDivElement.innerHTML = ''; // Pro jeden soubor (main_image) přepíšeme
                }
                const files = Array.from(e.target.files);
                files.forEach(file => {
                    displayImagePreview(file, previewDivElement);
                });
            });
        }

        setupImageUploadPreview(mainImageUploadInput, mainImagePreviewDiv);
        setupImageUploadPreview(subImageUploadInput, subImagePreviewDiv);
        setupImageUploadPreview(receivedImagesUploadInput, receivedImagesPreviewDiv);


        // Načtení a naplnění kategorií
        async function loadCategories() {
            try {
                const response = await fetch('/api/admin/products/categories');
                if (!response.ok) {
                    throw new Error(`Chyba při načítání kategorií: ${response.status}`);
                }
                const categories = await response.json();
                categorySelect.innerHTML = '<option value="">Vyberte kategorii...</option>'; // Výchozí možnost
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id; // Používáme ID kategorie jako hodnotu
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
            } catch (error) {
                console.error("Nepodařilo se načíst kategorie:", error);
                categorySelect.innerHTML = '<option value="">Chyba při načítání kategorií</option>';
                msgArea.innerHTML = `<p class="error-message">Nepodařilo se načíst kategorie: ${error.message}</p>`;
            }
        }

        // Zpracování textového vstupu pro "Likes" do JSON pole
        likesInputText.addEventListener('input', (event) => {
            const items = event.target.value.split(',')
                            .map(item => item.trim())
                            .filter(item => item !== '');
            likesHidden.value = JSON.stringify(items);
        });


        form.addEventListener('submit', async e => {
            e.preventDefault();
            msgArea.innerHTML = '';

            // Likes jsou již zpracovány do hidden inputu 'likes'
            // Není potřeba speciální logiky pro FormData, pokud jsou name atributy správně.
            const formData = new FormData(form);

            // Pro kontrolu, co se odesílá:
            // for (let [key, value] of formData.entries()) {
            //     console.log(`${key}: ${value}`);
            // }

            try {
                const res = await fetch('/api/admin/products', {
                    method: 'POST',
                    body: formData // FormData automaticky nastaví Content-Type na multipart/form-data
                });

                const json = await res.json();

                if (res.ok) {
                    msgArea.innerHTML = '<p class="success-message">Produkt byl úspěšně vytvořen!</p>';
                    form.reset(); // Resetuje všechna pole formuláře
                    mainImagePreviewDiv.innerHTML = '';
                    subImagePreviewDiv.innerHTML = '';
                    receivedImagesPreviewDiv.innerHTML = '';
                    likesHidden.value = '[]'; // likesInputText se resetuje s form.reset()
                    // categorySelect se také resetuje s form.reset() na první option
                    // Skryté inputy pro URL se také resetují
                    document.getElementById('main_image_url').value = '';
                    document.getElementById('sub_image_urls').value = '[]';
                    document.getElementById('received_images_urls').value = '[]';

                } else {
                    msgArea.innerHTML = `<p class="error-message">Nepodařilo se vytvořit produkt: ${json.error || json.message || res.statusText}</p>`;
                }
            } catch (err) {
                console.error('Chyba při odesílání formuláře:', err);
                msgArea.innerHTML = '<p class="error-message">Došlo k chybě při vytváření produktu.</p>';
            }
        });

        // Načtení kategorií při startu
        document.addEventListener('DOMContentLoaded', () => {
            loadCategories();
        });
    </script>
</body>
</html>